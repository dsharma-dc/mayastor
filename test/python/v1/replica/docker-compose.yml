#
# {SRCDIR} should point to your working tree which should be your current pwd
#

version: '3'
services:
  ms0:
    container_name: "ms0"
    image: rust:latest
    environment:
        - MY_POD_IP=10.1.0.2
        - NEXUS_NVMF_ANA_ENABLE=1
        - NEXUS_NVMF_RESV_ENABLE=1
        - PATH=${LLVM_SYMBOLIZER_DIR:-}:${LVM_BINS:-}
        - ASAN_OPTIONS=detect_leaks=0
        - ENABLE_LVM=true
        - RUST_LOG=debug
    command: ${SRCDIR}/${IO_ENGINE_DIR}/io-engine -g 0.0.0.0 -l 1 -r /tmp/ms0.sock --reactor-freeze-detection
    networks:
      mayastor_net:
        ipv4_address: 10.1.0.2
    cap_add:
      # NUMA related
      - SYS_ADMIN
      - SYS_NICE
      # uring needs mmap
      - IPC_LOCK
    security_opt:
      # we can set this to a JSON file to allow per syscall access
      - seccomp=unconfined
    volumes:
      - ${SRCDIR}:${SRCDIR}
      - /nix:/nix
      - /dev/hugepages:/dev/hugepages
      - /tmp:/tmp
      - /var/tmp:/var/tmp
      - /dev:/dev
      - /run/udev:/run/udev
    privileged: true
    devices:
      - /dev/loop0
      - /dev/loop1
      - /dev/loop2
    ipc: "host"
networks:
  mayastor_net:
    name: mayastor_net
    ipam:
      driver: default
      config:
        - subnet: "10.1.0.0/16"
